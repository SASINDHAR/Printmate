<script>
/* =========================
   PrintMate â€“ Professional JS
   ========================= */

/* ---------- CONFIG ---------- */
const CONFIG = {
  PRICES: {
    bw_a4: 0.05,
    color_a4: 0.12,
    lamination: 1.5
  },
  DELIVERY_FEE: 2.5,
  TAX_RATE: 0.07,
  MAX_UPLOAD_MB: 5,
  WHATSAPP_NUMBER: "919959814416",
  STORAGE_KEYS: {
    CART: "printmate_cart",
    ORDERS: "printmate_orders",
    CURRENCY: "printmate_currency",
    LOW_DATA: "printmate_lowdata"
  }
};

/* ---------- DOM ---------- */
const DOM = {
  cartList: document.getElementById("cartList"),
  subtotal: document.getElementById("subtotal"),
  delivery: document.getElementById("delivery"),
  tax: document.getElementById("tax"),
  total: document.getElementById("total"),
  savedOrders: document.getElementById("savedOrders"),
  message: document.getElementById("message"),
  currency: document.getElementById("currency"),
  lowDataSwitch: document.getElementById("lowDataSwitch")
};

/* ---------- STATE ---------- */
const state = {
  cart: JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.CART)) || [],
  orders: JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.ORDERS)) || [],
  currency: localStorage.getItem(CONFIG.STORAGE_KEYS.CURRENCY) || "EUR",
  lowData: localStorage.getItem(CONFIG.STORAGE_KEYS.LOW_DATA) === "1"
};

DOM.currency.value = state.currency;

/* ---------- UTILITIES ---------- */
const currencySymbol = c =>
  ({ EUR:"â‚¬", INR:"â‚¹", USD:"$", NGN:"â‚¦", KES:"KSh", GHS:"GHS" }[c] || "");

const formatMoney = value =>
  `${currencySymbol(state.currency)}${value.toFixed(2)}`;

const save = (key, data) =>
  localStorage.setItem(key, JSON.stringify(data));

const notify = (msg, timeout = 3000) => {
  DOM.message.textContent = msg;
  setTimeout(() => DOM.message.textContent = "", timeout);
};

/* ---------- CALCULATIONS ---------- */
function calculateTotals() {
  let subtotal = 0;

  state.cart.forEach(item => {
    const unit = CONFIG.PRICES[item.service] || 0;
    if (item.service === "lamination") {
      subtotal += unit * item.qty;
    } else {
      subtotal += unit * item.pages * item.qty;
    }
  });

  const delivery = subtotal > 20 ? 0 : CONFIG.DELIVERY_FEE;
  const tax = subtotal * CONFIG.TAX_RATE;
  const total = subtotal + delivery + tax;

  DOM.subtotal.textContent = formatMoney(subtotal);
  DOM.delivery.textContent = formatMoney(delivery);
  DOM.tax.textContent = formatMoney(tax);
  DOM.total.textContent = formatMoney(total);

  return total;
}

/* ---------- RENDER ---------- */
function renderCart() {
  if (!state.cart.length) {
    DOM.cartList.textContent = "No items yet";
    return;
  }

  DOM.cartList.innerHTML = "";
  state.cart.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "order-item";
    div.innerHTML = `
      <div>
        <strong>${item.service.replace("_"," ")}</strong>
        <div class="tiny">${item.pages} pages Ã— ${item.qty}</div>
      </div>
      <button class="small ghost">Remove</button>
    `;
    div.querySelector("button").onclick = () => {
      state.cart.splice(i,1);
      save(CONFIG.STORAGE_KEYS.CART, state.cart);
      renderCart();
      calculateTotals();
    };
    DOM.cartList.appendChild(div);
  });
}

function renderOrders() {
  if (!state.orders.length) {
    DOM.savedOrders.textContent = "No saved orders";
    return;
  }

  DOM.savedOrders.innerHTML = "";
  [...state.orders].reverse().forEach(o => {
    const div = document.createElement("div");
    div.className = "order-item";
    div.innerHTML = `
      <div>
        <strong>${o.id}</strong>
        <div class="tiny">${new Date(o.created).toLocaleString()}</div>
      </div>
      <div class="status ${o.synced ? "done" : "pending"}">
        ${o.synced ? "Sent" : "Pending"}
      </div>
    `;
    DOM.savedOrders.appendChild(div);
  });
}

/* ---------- CART ---------- */
function addToCart() {
  const service = document.getElementById("service").value;
  const pages = Number(document.getElementById("pages").value) || 1;
  const qty = Number(document.getElementById("qty").value) || 1;
  const file = document.getElementById("file").files[0];

  if (file && file.size / (1024*1024) > CONFIG.MAX_UPLOAD_MB) {
    notify("File exceeds max size");
    return;
  }

  state.cart.push({ service, pages, qty, fileName: file?.name || null });
  save(CONFIG.STORAGE_KEYS.CART, state.cart);

  renderCart();
  calculateTotals();
  notify("Item added to cart");
}

/* ---------- ORDER ---------- */
function placeOrder(isOnline) {
  if (!state.cart.length) return notify("Cart is empty");

  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const addr = document.getElementById("addr").value.trim() || "Pickup";

  if (!name || !phone) return notify("Name & phone required");

  const order = {
    id: "PM-" + Date.now(),
    created: Date.now(),
    customer: { name, phone, addr },
    items: state.cart,
    currency: state.currency,
    total: DOM.total.textContent,
    synced: navigator.onLine && isOnline,
    method: isOnline ? "online" : "cod"
  };

  state.orders.push(order);
  save(CONFIG.STORAGE_KEYS.ORDERS, state.orders);

  state.cart = [];
  save(CONFIG.STORAGE_KEYS.CART, state.cart);

  renderCart();
  renderOrders();
  notify("Order saved");

  sendToWhatsApp(order);
}

/* ---------- WHATSAPP ---------- */
function sendToWhatsApp(order) {
  let msg = `ðŸŸ¢ *New Print Order*\nOrder: ${order.id}\nName: ${order.customer.name}\nPhone: ${order.customer.phone}\n\nItems:\n`;
  order.items.forEach(i =>
    msg += `â€¢ ${i.service} (${i.pages} Ã— ${i.qty})\n`
  );
  msg += `\nTotal: ${order.total}`;

  window.open(
    `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`,
    "_blank"
  );
}

/* ---------- EVENTS ---------- */
document.getElementById("addBtn").onclick = addToCart;
document.getElementById("placeBtn").onclick = () => placeOrder(true);
document.getElementById("codBtn").onclick = () => placeOrder(false);

/* ---------- INIT ---------- */
renderCart();
renderOrders();
calculateTotals();
</script>
