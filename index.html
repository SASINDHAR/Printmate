<script>
document.addEventListener("DOMContentLoaded", () => {

/* =========================
   CONFIG
========================= */
const CONFIG = {
  PRICES: { bw_a4: 0.05, color_a4: 0.12, lamination: 1.5 },
  DELIVERY_FEE: 2.5,
  TAX_RATE: 0.07,
  MAX_UPLOAD_MB: 5,
  WHATSAPP: "919959814416"
};

/* =========================
   DOM
========================= */
const $ = id => document.getElementById(id);

const DOM = {
  cartList: $("cartList"),
  subtotal: $("subtotal"),
  delivery: $("delivery"),
  tax: $("tax"),
  total: $("total"),
  savedOrders: $("savedOrders"),
  message: $("message"),
  currency: $("currency"),
  lowDataSwitch: $("lowDataSwitch"),
  max1: $("maxsizeLabel"),
  max2: $("maxsizeLabelFooter")
};

if (DOM.max1) DOM.max1.textContent = CONFIG.MAX_UPLOAD_MB;
if (DOM.max2) DOM.max2.textContent = CONFIG.MAX_UPLOAD_MB;

/* =========================
   STATE
========================= */
const state = {
  cart: JSON.parse(localStorage.getItem("printmate_cart") || "[]"),
  orders: JSON.parse(localStorage.getItem("printmate_orders") || "[]"),
  currency: localStorage.getItem("printmate_currency") || "EUR"
};

DOM.currency.value = state.currency;

/* =========================
   UTIL
========================= */
const symbol = c => ({EUR:"€", INR:"₹", USD:"$", NGN:"₦", KES:"KSh", GHS:"GHS"}[c]||"");
const money = v => symbol(state.currency) + v.toFixed(2);

const save = () => {
  localStorage.setItem("printmate_cart", JSON.stringify(state.cart));
  localStorage.setItem("printmate_orders", JSON.stringify(state.orders));
};

const msg = t => {
  DOM.message.textContent = t;
  setTimeout(()=>DOM.message.textContent="",3000);
};

/* =========================
   CALCULATE
========================= */
function calculate() {
  let sub = 0;
  state.cart.forEach(i => {
    const p = CONFIG.PRICES[i.service] || 0;
    sub += i.service === "lamination"
      ? p * i.qty
      : p * i.pages * i.qty;
  });
  const del = sub > 20 ? 0 : CONFIG.DELIVERY_FEE;
  const tax = sub * CONFIG.TAX_RATE;
  const total = sub + del + tax;

  DOM.subtotal.textContent = money(sub);
  DOM.delivery.textContent = money(del);
  DOM.tax.textContent = money(tax);
  DOM.total.textContent = money(total);
}

/* =========================
   RENDER
========================= */
function renderCart() {
  if (!state.cart.length) {
    DOM.cartList.textContent = "No items yet";
    return;
  }
  DOM.cartList.innerHTML = "";
  state.cart.forEach((i, idx) => {
    const d = document.createElement("div");
    d.className = "order-item";
    d.innerHTML = `
      <div><strong>${i.service}</strong><div class="tiny">${i.pages} × ${i.qty}</div></div>
      <button class="small ghost">Remove</button>
    `;
    d.querySelector("button").onclick = () => {
      state.cart.splice(idx,1);
      save(); renderCart(); calculate();
    };
    DOM.cartList.appendChild(d);
  });
}

function renderOrders() {
  if (!state.orders.length) {
    DOM.savedOrders.textContent = "No saved orders";
    return;
  }
  DOM.savedOrders.innerHTML = "";
  state.orders.slice().reverse().forEach(o => {
    const d = document.createElement("div");
    d.className = "order-item";
    d.innerHTML = `
      <div><strong>${o.id}</strong><div class="tiny">${new Date(o.created).toLocaleString()}</div></div>
      <div class="status ${o.synced?"done":"pending"}">${o.synced?"Sent":"Pending"}</div>
    `;
    DOM.savedOrders.appendChild(d);
  });
}

/* =========================
   CART
========================= */
$("addBtn").onclick = () => {
  state.cart.push({
    service: $("service").value,
    pages: Number($("pages").value||1),
    qty: Number($("qty").value||1)
  });
  save(); renderCart(); calculate(); msg("Added to cart");
};

/* =========================
   ORDER
========================= */
function placeOrder(online) {
  if (!state.cart.length) return msg("Cart empty");

  const name = $("name").value.trim();
  const phone = $("phone").value.trim();
  if (!name || !phone) return msg("Name & phone required");

  const order = {
    id: "PM"+Date.now(),
    created: Date.now(),
    items: state.cart,
    synced: navigator.onLine && online
  };

  state.orders.push(order);
  state.cart = [];
  save(); renderCart(); renderOrders(); calculate();

  window.open(
    `https://wa.me/${CONFIG.WHATSAPP}?text=${encodeURIComponent("New Order "+order.id)}`,
    "_blank"
  );
}

$("placeBtn").onclick = ()=>placeOrder(true);
$("codBtn").onclick = ()=>placeOrder(false);

/* =========================
   INIT
========================= */
renderCart();
renderOrders();
calculate();

});
</script>
